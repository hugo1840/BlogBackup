@[TOC](Oracle数据库存储结构：逻辑存储结构（三）)

# 表空间
表空间（tablespace）是段的逻辑存储容器。在物理层面上，表空间将数据存储在一个或多个数据文件（data files）或临时文件（temp files）中。数据库必须有 `SYSTEM` 和 `SYSAUX` 表空间。图1展示了一个典型数据库中的表空间。

>**图1 表空间**
![在这里插入图片描述](https://img-blog.csdnimg.cn/img_convert/e3b629287ca9c49a382b003fd431bbc0.gif#pic_center)

## 永久表空间
永久表空间（permanent tablespace）用于组织持久化的schema对象。表空间中对象的段以物理方式存储于数据文件中。每个数据库用户都会被分配一个默认的永久表空间。Oracle推荐至少创建一个表空间来存放用户和应用数据。表空间可用于以下目的：

- 控制数据库数据的磁盘空间分配；
- 为数据库用户分配空间限额（quota）；
- 将单个表空间上线或离线不会影响到整个数据库的可用性；
- 对单独的表空间进行备份和还原；
- 利用Oracle数据泵（Data Pump）功能导入导出应用数据；
- 创建可迁移的表空间（transportable tablespace）并将其从一个数据库移动到另一个（甚至跨平台）；
  通过迁移表空间来移动数据比使用 `export/import` 或 `unload/load` 要快很多，因为只涉及到复制数据文件、以及整合表空间元数据。迁移表空间时也能一同迁移索引数据。

### SYSTEM
系统表空间 `SYSTEM` 是在创建数据库时就包含了的一个必要的管理表空间。Oracle数据库利用 SYSTEM表空间来管理数据库。`SYSTEM` 表空间属于`SYS` 用户，其中包含以下信息：

- 数据字典；
- 包含数据库管理信息的表和视图；
- 编译过的存储对象，例如触发器（trigger）、存储过程（procedure）、包（package）。

SYSTEM表空间相对其他非系统表空间来说需要更高的权限才能访问，且受到一些特殊限制。比如，不可以重命名或者删除SYSTEM表空间。

Oracle数据库默认将所有新创建的用户表空间设置为**本地管理模式**。如果SYSTEM表空间是本地管理模式的，就不能创建字典管理的表空间（deprecated）。但是，如果手动执行 `CREATE TABLESPACE` 来创建SYSTEM表空间，并接受默认选项，那么SYSTEM表空间就是字典管理模式的。你也可以将现存的字典管理模式下的SYSTEM表空间迁移到本地管理模式。Oracle强烈建议使用DBCA来创建新的数据库，这样包括SYSTEM在内的所有表空间 都将默认为本地管理模式。

### SYSAUX
SYSAUX表空间是SYSTEM的一个辅助表空间。SYSAUX是许多Oracle数据库功能和产品的默认表空间。以前，这些功能和产品都有自己的表空间。使用SYSAUX表空间减少了数据库所需要的表空间的数量，也减小了SYSTEM表空间上的负载。

创建或升级数据库时会自动创建SYSAUX表空间。在数据库正常运行时，不允许删除或重命名SYSAUX表空间。即使SYSAUX表空间不可用了，数据库的核心功能仍然可以运行。但是，使用了SYSAUX表空间的数据库功能可能会失败、或者会受到一定的限制。

### Undo表空间
undo表空间是为系统管理的undo数据保留的一个本地管理模式的表空间。与其他永久表空间类似，undo表空间中也有数据文件，其中的undo数据块按区分组。

**\#1 自动undo管理模式**
undo表空间要求数据库处于默认自动undo模式（default automatic undo mode）。自动模式下，数据库会自动调整来提供可能最优的undo数据保留量，以满足长查询的需求。

一个数据库可以有多个undo表空间，但是一次只能使用一个（即不能同时使用多个undo表空间）。当有数据库实例尝试打开数据库时，Oracle会自动选择第一个可用的undo表空间。如果没有可用的undo表空间，数据库实例会以无undo表空间模式启动，并将undo数据存储在SYSTEM表空间中（应该避免出现这种情况）。

**\#2 自动undo保留**
undo保留周期（**undo retention period**）是Oracle数据库在覆写旧的undo数据之前将其保留的**最短**时间。undo数据的保留很重要，一是因为长时间运行的查询可能需要旧的数据来提供读一致性，二是有一些闪回（flashback）功能也可能依赖undo数据。

通常来说，我们都希望undo数据能够保留越久越好。在事务提交后，undo数据不会被再用于事务回滚或者事务恢复。在undo表空间够用的情况下，数据库可以一直保留undo数据。当可用空间很少时，数据库就会开始覆写已提交事务的undo数据。

### Shadow表空间
shadow表空间是用于影子写丢失保护（**shadow lost write protection**）的大文件表空间（**bigfile tablespace**）。注意：Shadow lost write protection与初始化参数 `DB_LOST_WRITE_PROTECT` 配置的写丢失保护机制**没有**关系。

**\#1 Shadow表空间的用途**
影子写丢失保护提供了**写丢失**（**lost write**）的快速检测和即时反应。当I/O子系统承认了一个数据块写操作的完成，但是实际并未发生写操作、或者数据块的前一个像（image）覆写了当前的像，就是发生了数据块的写丢失。未检测到的写丢失可能会导致数据损坏（data corruption），如果错误的数据被用于DML事务。例如，一个事务读取到错误的值后，更新了其他表中成百上千的行数据。

影子写丢失保护具有以下优点：

- 在进行标准DML操作、SQL Loader常规路径加载和直接路径加载、以及RMAN备份前，对数据块进行写丢失检测；
- 不需要备库（standby database）；
- 可以对特定的表空间或者数据文件启用影子写丢失保护功能，而不必跟踪检测所有数据；
- 可以用一个shadow表空间替换另一个，以达到修改其配置或位置的目的；
- 可以停用或重新启用（suspend and resume）表空间或数据文件的影子写丢失保护功能；
- 执行 `ALTER DATABASE ... LOST WRITE TRACKING` 就能开启或禁用整个非CDB数据或PDB数据库的影子写丢失保护功能。

**\#2 Shadow表空间的功能实现**
写丢失保护机制需要两个表空间才能实现：一个shadow表空间、以及一个被shadow表空间跟踪数据块的非shadow表空间。图2展示了一个简单的场景：TBS1和TBS2两个表空间、以及TBS3中的DBF6数据文件都被shadow表空间跟踪了数据块。

>**图2 shadow表空间：写丢失保护**
![在这里插入图片描述](https://img-blog.csdnimg.cn/img_convert/e5d1be2953623a7ae8ced78051b205cf.png#pic_center)

其中，每个被跟踪的**数据文件**（tracked data file）都会映射到shadow表空间中的一个**shadow区**。被跟踪的数据文件中，每个数据块在shadow区中都有对应的记录。该记录包含了数据块的**SCN**（System Change Number）。每当有被跟踪的数据块被从磁盘读取时，影子写丢失保护功能会比较shadow表空间里记录的SCN与数据块中最新写入操作的SCN。如果shadow表空间里记录的SCN比正在读取的数据块的SCN要大，就说明发生了写丢失，数据库就会提示错误信息。


**\#3 Shadow表空间的监视视图**
下面的数据字典视图中监视了shadow表空间的状况：

- `DBA_TABLESPACES`：可以查看哪些表空间是shadow表空间；
- `DBA_DATA_FILES.LOST_WRITE_PROTECT`：可以查看是否对某个数据文件开启了写丢失保护功能；
- `USER_TABLESPACES.LOST_WRITE_PROTECT`：可以查看是否对某个表空间开启了写丢失保护功能。
  

## 临时表空间
临时表空间（temporary tablespace）存有持续时间不超过一个会话的临时数据。临时文件（temp file）中存储了临时表空间的数据。临时表空间可以提高不能在内存中进行的多个排序操作的并发度，还可以提高排序操作的存储空间管理效率。

###  共享 vs 本地
临时表空间可以是共享的，也可以是本地的。**共享临时表空间**在共享盘上存储临时文件，因此所有数据库实例都能访问临时空间。**本地临时表空间**则单独为每个数据库实例分别存储临时文件。

只读数据库实例或者可读写数据库实例都能创建本地临时表空间。当有多个只读实例访问同一个数据库时，本地临时表空间能够提升包含了排序、哈希聚合（hash aggregations）、Join连接的查询的性能。

| 共享临时表空间 | 本地临时表空间 |
|--|--|
| 创建语句为：`Create Temporary Tablespace` | 创建语句为：`Create Local Temporary Tablespace` |
| 为数据库创建单个临时表空间 | 为每个数据库实例都创建一个临时表空间。<br>`For Leaf` 选项仅为只读实例创建，`For All` 同时为只读和可读写实例创建 |
| 支持表空间组 | 不支持表空间组 |
| 将临时文件的元数据存储在控制文件中 | 将所有实例共有的临时文件元数据存储在控制文件中，<br>同时将单个实例特定的元数据存储在实例SGA中 |

###  默认临时表空间
每个数据库用户都会被分配一个默认的共享临时表空间。如果数据库有本地的临时表空间，那么每个用户账户也都会被分配默认的本地临时存储。利用 `CREATE USER` 或者 `ALTER USER` 语句可以为用户指定一个临时表空间。

需要注意的是，如果SYSTEM表空间不是本地管理模式的，并且在执行 `CREATE DATABASE` 创建数据库时未指定默认的临时表空间，数据库就会将SYSTEM表空间作为默认的临时存储，并在alert log中记录一个警告信息。

## 表空间的模式
表空间的模式决定了其是否能被访问、以及能被访问的方式。

###  可读写 vs 只读
读写模式决定了表空间能否被修改。以下两种模式互斥：

- 读写模式（**RW**）：用户可以读写表空间。==SYSTEM、SYSAUX、以及临时表空间只能是读写模式==，不能被改成只读模式；
- 只读模式（**RO**）：表空间中的数据文件不接受写入操作。只读表空间不需要重复备份，在介质失败后也不需要恢复。

###  在线 vs 离线
在数据库打开时，表空间可以处于在线模式（online），也可以处于离线模式（offline）。表空间只有在线才能被用户访问。==SYSTEM和临时表空间只能处于在线模式==。

表空间可以自动也可以手动离线。离线表空间一般是为了进行备份或者恢复。数据库会自动离线发生错误的表空间，例如当DBW进程无法写入表空间中的数据文件时。用户试图访问离线的表空间时会收到错误提示。当表空间离线时，数据库会进行以下工作：

- 数据库会禁止接下来对离线表空间中对象的DML操作。离线的表空间只能被Oracle数据库本身读取或修改；
- 引用了离线表空间中的数据、但SQL语句已执行完成的活跃事务在事务层面上不会受到影响；
- 数据库会根据SYSTEM表空间中deferred undo段中的已完成的SQL语句来保存undo数据。当表空间再次上线时，数据库会根据需要将保存的undo数据应用到表空间。

## 表空间文件大小
表空间可以分为大文件表空间（bigfile tablespace）或者小文件表空间（smallfile tablespace）。两者的区别如下：

- **小文件表空间**可以包含**多个**数据文件或者临时文件，但是比大文件表空间里的要小。小文件表空间是**默认**的表空间类型。
- **大文件表空间**只包含**一个**特别大的数据文件或者临时文件。大文件表空间可以用来：
  * 扩大数据库的存储容量：一个数据库中数据文件的最大数量是有限制的，增大每个数据文件的大小可以提高数据库总的容量；
  * 减轻管理多个数据文件和临时文件的负担：大文件表空间通过利用Oracle Managed Files和ASM可以简化文件管理；
  * 在表空间（而不是单个文件）上进行操作：大文件表空间使得表空间成为了磁盘空间管理、备份、恢复等操作的主要单位。

大文件表空间仅在本地管理的表空间中的ASSM模式下才支持。但是，即使段空间是手动管理的（MSSM），本地管理的undo和临时表空间也可以是大文件表空间。


**References**
[1\] https://docs.oracle.com/en/database/oracle/oracle-database/19/cncpt/logical-storage-structures.html#GUID-13CE5EDA-8C66-4CA0-87B5-4069215A368D
